@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .
@prefix v-fs: <http://semantic-machines.com/veda/veda-function-search/> .

<http://semantic-machines.com/veda/veda-admin-aspect>
  rdf:type owl:Ontology ;
  rdfs:label "Veda system individuals' complex labels ontology"@en ;
  rdfs:label "Онтология комплексного наименования индивидов системы Veda"@ru ;
#  owl:versionInfo "1.3" ;
  v-s:loadPriority 7 ;
.

v-s:UserScript
  rdf:type owl:Class ;
  rdfs:label "User script"@en ;
  rdfs:label "Пользовательский скрипт"@ru ;
.

v-s:scriptOutput
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Output"@en ;
  rdfs:label "Вывод"@ru ;
  rdfs:domain v-s:UserScript ;
  rdfs:range xsd:string ;
.

v-s:toBeRun
  rdf:type owl:DatatypeProperty ;
  rdfs:label "To be run"@en ;
  rdfs:label "Выполнить"@ru ;
  rdfs:domain v-s:UserScript ;
  rdfs:range xsd:boolean ;
.

v-s:lastRun
  rdf:type owl:DatatypeProperty ;
  rdfs:label "Last run"@en ;
  rdfs:label "Последний запуск"@ru ;
  rdfs:domain v-s:UserScript ;
  rdfs:range xsd:dateTime ;
.

v-s:UserScriptEvent
  rdf:type v-s:Event ;
  v-s:filter v-s:UserScript ;
  v-s:script """
/* Available variables:
 * ticket = superuser ticket
 * document = captured document
 * user_uri = user whose actions triggered event
 * prev_state = user whose actions triggered event
 * _event_id = id of the event to prevent cycles in triggers. Must be passed to every function that modifies DB.
 * parent_script_id = id of the parent script that triggered this event.
 * parent_document_id = id of the document that triggered this event.
 */
var toBeRun = document["v-s:toBeRun"] && document["v-s:toBeRun"][0] && document["v-s:toBeRun"][0].data ;

if (!toBeRun) { return }

// preserve global print()
var console_print = this.print;

// override global print()
this.print = function () {
  for (var i = 0; i < arguments.length; i++) {
    var arg = arguments[i] ;
    if (i === 0) {
      output += arg.toString();
    } else {
      output += " " + arg.toString();
    }
  }
  output += String.fromCharCode(13, 10);
}
var output = "";
var script = document["v-s:script"] && document["v-s:script"][0] && document["v-s:script"][0].data;
try {
  eval(script);
} catch (ex) {
  print(ex);
}
document["v-s:scriptOutput"] = [{
  data: output,
  lang: "NONE",
  type: _String
}];
document["v-s:lastRun"] = [{
  data: new Date(),
  type: _Datetime
}];
delete document["v-s:toBeRun"];
put_individual(ticket, document, _event_id);

// restore global print()
this.print = console_print;

"""
.

v-s:RunBundle
  rdf:type v-s:Bundle ;
  rdfs:label "Run"@en ;
  rdfs:label "Запустить"@ru ;
.

v-s:UserScriptTemplate
  rdf:type v-ui:ClassTemplate ;
  v-ui:forClass v-s:UserScript ;
  rdfs:label "Template for v-s:UserScript class"@en ;
  rdfs:label "Шаблон для класса v-s:UserScript"@ru ;
  v-ui:template """
<div class="container-fluid">
  <h2 about="v-s:UserScript" property="rdfs:label"></h2>

  <div class="row">
    <div class="col-md-3">
      <em about="rdfs:label" property="rdfs:label"></em>
      <div property="rdfs:label" class="view -edit -search"></div>
      <veda-control property="rdfs:label" type="string" class="-view edit search"></veda-control>
    </div>
    <div class="col-md-3 view -edit -search">
      <em about="v-s:lastRun" property="rdfs:label"></em>
      <div about="@" property="v-s:lastRun"></div>
    </div>
    <div class="col-md-3 view -edit -search">
      <em about="v-s:updateCounter" property="rdfs:label"></em>
      <div about="@" property="v-s:updateCounter"></div>
    </div>
    <div class="col-md-3 view -edit -search">
      <div class="checkbox">
        <label>
          <veda-control property="v-s:toBeRun" data-type="boolean"></veda-control>
          <em about="v-s:toBeRun" property="rdfs:label"></em>
        </label>
      </div>
    </div>
  </div>

  <hr>

  <div class="row">
    <div class="col-md-6">
      <em about="v-s:script" property="rdfs:label" class="view edit -search"></em>
      <veda-control property="v-s:script" data-type="source" class="view edit -search"></veda-control>
    </div>
    <div class="col-md-6">
      <em about="v-s:scriptOutput" property="rdfs:label" class="view edit -search"></em>
      <pre about="@" property="v-s:scriptOutput" class="view edit -search" style="height:300px; overflow:auto"></pre>
    </div>
  </div>

  <div class="-view -edit search" about="@" data-template="v-ui:SystemPropertiesTemplate" data-embedded="true"></div>

  <br>

  <div class="view edit -search">
    <button type="button" class="action btn btn-primary view -edit -search" id="edit" about="v-s:Edit" property="rdfs:label"/>
    <button type="button" class="action btn btn-success -view edit -search save" id="save" about="v-s:Save" property="rdfs:label"/>
    <button type="button" class="action btn btn-default -view edit -search" id="cancel" about="v-s:Cancel" property="rdfs:label"/>
    <button type="button" class="action btn btn-link view edit -search" id="delete" about="v-s:Delete" property="rdfs:label"/>
    <button type="button" class="action btn btn-danger view -edit -search" id="run" about="v-s:RunBundle" property="rdfs:label"/>
  </div>

</div>
<script>
  $(".action#run", template).click(function () {
    individual["v-s:toBeRun"] = [ true ];
    individual.save();
  });
</script>
  """
.

# -- ИНДИВИДЫ START --

v-s:AdministrationAspect
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:BusinessAspect ;
  rdfs:label "Administration"@en ;
  rdfs:label "Администрирование"@ru ;
  rdfs:comment "Administration aspect"@en ;
  rdfs:comment "Аспект администрирования"@ru ;
.

v-s:AdministrationAspect1
  rdf:type v-s:AdministrationAspect ;
  rdfs:label "Administration"@en ;
  rdfs:label "Администрирование"@ru ;
  rdfs:comment "All your base are belong to us" ;
  v-s:shortLabel "Administration"@en ;
  v-s:shortLabel "Администрирование"@ru ;
  v-s:hasImage v-s:AdministrationImage ;
  v-s:hasBlank v-s:CreateUserScript ;
  v-s:hasRegistry v-s:UserScriptRegistry ;
.

v-s:AdministrationImage
  a v-s:File ;
  v-s:fileUri "administration.jpg"^^xsd:string ;
  v-s:fileName "administration.jpg"^^xsd:string ;
  v-s:filePath "/veda"^^xsd:string ;
.

# -- НАПОЛНЕНИЕ АСПЕКТА АДМИНИСТИРОВАНИЯ --

v-s:CreateUserScript
  a v-fc:Blank ;
  rdfs:label "Скрипт"@ru ;
  rdfs:label "Script"@en ;
  v-fc:targetType v-s:UserScript ;
.
v-s:UserScriptRegistry
  a v-fs:AttributiveSearch;
  v-fs:typeToSearch v-s:UserScript;
  rdfs:label "Все скрипты"@ru;
  rdfs:label "All scripts"@en;
  v-fs:searchBlank v-s:UserScriptBlank ;
  v-fs:searchBlankTemplate v-s:UserScriptTemplate ;
  v-fs:searchResultTemplate v-s:UserScriptResultTemplate ;
.

v-s:UserScriptBlank
  rdf:type v-fc:Blank ;
  rdfs:label "Все скрипты"@ru ;
  rdfs:label "All scripts"@en ;
  v-fc:targetType v-s:UserScript ;
.

v-s:UserScriptResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения результатов реестра скриптов"@ru ;
  rdfs:label "Scripts registry result template "@en ;
  v-ui:template """
<table class="table table-bordered">
  <thead class="result-header">
    <tr>
      <th colspan="7" about="v-s:UserScript" property="rdfs:label"></th>
    </tr>
    <tr class="active">
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th class="orderby" data-orderby="rdfs:label"><span about="rdfs:label" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:creator"><span about="v-s:creator" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:created"><span about="v-s:created" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:lastEditor"><span about="v-s:lastEditor" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:edited"><span about="v-s:edited" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td>###</td>
      <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
      <td property="rdfs:label"></td>
      <td rel="v-s:creator"><span property="rdfs:label"></span></td>
      <td property="v-s:created"></td>
      <td rel="v-s:lastEditor"><span property="rdfs:label"></span></td>
      <td property="v-s:edited"></td>
    </tr>
  </tbody>
</table>
  """ ;
.

# -- НАПОЛНЕНИЕ АСПЕКТА АДМИНИСТРИРОВАНИЯ END --

# -- ШАБЛОН АСПЕКТА АДМИНИСТРИРОВАНИЯ --
v-s:AdministrationAspectTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон для класса Аспекта администирования"@ru ;
  rdfs:label "Template for Administration aspect class"@en ;
  v-ui:forClass v-s:AdministrationAspect ;
  v-ui:template """
<div class="container-fluid" style="position:relative;">
  <div class="row">
    <div class="col-md-4">
      <div class="container-fluid">
        <h4 class="text-center" style="text-transform: uppercase"><i class="fa fa-file-text-o"></i> <span about="v-s:Blanks" property="rdfs:label"></span></h4>
        <hr>
        <div about="@" rel="v-s:hasBlank">
          <div>
            <a href="#/@" class="btn btn-success btn-lg btn-block"><span property="rdfs:label"></span></a>
            <br>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="container-fluid">
        <h4 class="text-center" style="text-transform: uppercase"><i class="fa fa-table"></i> <span about="v-s:Registries" property="rdfs:label"></span></h4>
        <hr>
        <div about="@" rel="v-s:hasRegistry">
          <div>
            <a href="#/@" class="btn btn-info btn-lg btn-block"><span property="rdfs:label"></span></a>
            <br>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="container-fluid">
        <h4 class="text-center" style="text-transform: uppercase"><i class="fa fa-bar-chart"></i> <span about="v-s:Reports" property="rdfs:label"></span></h4>
        <hr>
        <div about="@" rel="v-s:hasReport">
          <div>
            <a href="#/@" class="btn btn-warning btn-lg btn-block"><span property="rdfs:label"></span></a>
            <br>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  """ ;
.
