@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

@prefix v-te: <http://semantic-machines.com/veda/veda-editor/> .
<http://semantic-machines.com/veda/veda-transformation-editor>
  rdf:type owl:Ontology ;
  rdfs:label "Veda transformation editor ontology"@en ;
  rdfs:label "Онтология редактора трансформаций системы Веда"@ru ;
#  owl:versionInfo "0.2" ;
  v-s:loadPriority 9 ;
.

########## TRANSFORMATION EDITOR ###########

v-te:TransformationEditor
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:SystemThing ;
  rdfs:label "Function Create"@en ;
  rdfs:label "Функция Создать"@ru ;
  v-ui:hasModel v-te:TransformationEditorModel ;
  v-ui:hasTemplate v-te:TransformationEditorTemplate ;
.
v-te:Blank
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:SystemThing ;
  rdfs:label "Бланк"@ru ;
  rdfs:label "Blank"@en ;
  v-ui:hasModel v-te:BlankModel ;
  v-ui:hasTemplate v-te:BlankTemplateShort ;
.
v-te:BlankMgmt
  rdf:type v-s:Bundle ;
  rdfs:label "Запомнить"@ru ;
  rdfs:label "Remember"@en ;
.
v-te:Editor
  rdf:type v-te:TransformationEditor ;
  rdfs:label "Transformation editor"@en ;
  rdfs:label "Редактор трансформаций"@ru ;
.
v-te:ChooseType
  rdf:type v-s:Bundle ;
  rdfs:label "Choose codlet to add"@en ;
  rdfs:label "Выберите кодлет для добавления"@ru ;
.
v-te:targetType
  rdf:type owl:ObjectProperty ;
  rdfs:label "Type"@en ;
  rdfs:label "Тип"@ru ;
  rdfs:domain v-te:Blank ;
  rdfs:range owl:Class ;
  rdfs:range rdfs:Class ;
.
v-te:TargetTypeSpec
  rdf:type v-ui:ObjectPropertySpecification ;
  rdfs:label "Спецификация свойства v-te:targetType"@ru ;
  rdfs:label "v-te:targetType property specification"@en ;
  v-ui:forClass v-te:Blank, v-te:TransformationEditor ;
  v-ui:forProperty v-te:targetType ;
  v-ui:tooltip "Ссылка на объект класса Класс."@ru ;
  v-ui:tooltip "Link to instance of Class class"@en ;
  v-ui:queryPrefix "('rdf:type'=='owl:Class'||'rdf:type'=='rdfs:Class')"^^xsd:string ;
  v-ui:maxCardinality "1"^^xsd:integer ;
  v-ui:minCardinality "1"^^xsd:integer ;
.

v-te:LabelSpec
  rdf:type v-ui:DatatypePropertySpecification ;
  rdfs:label "Спецификация свойства rdfs:label для класса v-te:Blank"@ru ;
  rdfs:label "Rdfs:label property specification for class v-te:Blank"@en ;
  v-ui:forClass v-te:Blank ;
  v-ui:forProperty rdfs:label ;
  v-ui:tooltip "Обязательно. Строка произвольной длины."@ru ;
  v-ui:tooltip "Mandatory. Arbitrary length string."@en ;
  v-ui:maxCardinality "1"^^xsd:integer ;
  v-ui:minCardinality "1"^^xsd:integer ;
.
v-te:TransformationEditorModel
  rdf:type v-ui:ClassModel ;
  rdfs:label "v-te:TransformationEditor class model"@en ;
  rdfs:label "Модель класса v-te:TransformationEditor"@ru ;
  v-ui:forClass v-te:TransformationEditor ;
  v-s:script """
var self = this;
//# sourceURL=v-te:TransformationEditorModel
  """
.
v-te:TransformationEditorTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "v-te:TransformationEditor class template"@en ;
  rdfs:label "Шаблон класса v-te:TransformationEditor"@ru ;
  v-ui:forClass v-te:TransformationEditor ;
  v-ui:template """
<div class="container sheet">
  <h3 property="rdfs:label"></h3>
  <hr>
  <div class="row">
    <div class="col-md-12 col-sm-12" style="border-left: 1px solid gainsboro;">
      <h4 about="v-te:ChooseType" property="rdfs:label"></h4>
      <veda-control rel="v-te:targetType" data-type="link" class="fulltext dropdown"></veda-control>
      <br>
      <div id="holder"></div>
    </div>
  </div>
</div>
<script>
  var self = individual;
  var blankTemplate = new veda.IndividualModel("v-te:BlankTemplate");
  function typeHandler(values) {
    alert('Get values ' + values);
    var holder = $("#holder", template).empty();
    if (values.length) {
      var blank = new veda.IndividualModel();
      blank["v-te:targetType"] = values;
      blank["rdf:type"] = [ new veda.IndividualModel("v-te:Blank") ];
      blank.present(holder, blankTemplate, "edit");
    }
  }
  self.on("v-te:targetType", typeHandler);
  template.one("remove", function () {
    self.off("v-te:targetType", typeHandler);
  });
  if (self.hasValue("v-te:targetType")) {
    typeHandler(self["v-te:targetType"]);
  }
  var blanksHolder = $("#blanks", template),
    asp = veda.user.aspect,
    blanks = asp["v-s:hasBlank"];
  if (blanks) {
    blanks.map( function (blank) {
      var cont = $("<li>").appendTo(blanksHolder);
      blank.present( cont, new veda.IndividualModel("v-ui:LabelBlockLinkTemplate") );
    });
  }
  //# sourceURL=v-te:TransformationEditorTemplate
</script>
  """
.

v-te:BlankModel
  rdf:type v-ui:ClassModel ;
  rdfs:label "v-te:Blank class model"@en ;
  rdfs:label "Модель класса v-te:Blank"@ru ;
  v-ui:forClass v-te:Blank ;
  v-s:script """
var self = this,
  asp = veda.user.aspect;

var stopList = [
  "@",
  "rdf:type",
  "v-s:author",
  "v-s:publisher",
  "v-s:creator",
  "v-s:lastEditor",
  "v-s:created",
  "v-s:edited",
  "v-s:updateCounter",
  "v-s:deleted",
  "rdfs:label",
  "rdfs:isDefinedBy",
  "v-te:targetType"
];

this._init = function () {
  if (self.object) { return; }
  self.object = new veda.IndividualModel(),
  self.object["rdf:type"] = self["v-te:targetType"].slice(0);
  Object.getOwnPropertyNames(self.properties).map( function (property_uri) {
    if ( stopList.indexOf(property_uri) >= 0 ) { return; }
    if ( self.hasValue(property_uri) && self[property_uri][0] instanceof veda.IndividualModel && self[property_uri][0].is("v-te:Blank") ) {
      self.object[property_uri] = self[property_uri].map(function (item) {
        // Embedded blanks are for v-s:Embedded objects only
        // Prevent mutual v-s:parent links
        item._init();
        if ( item.object.is("v-s:Embedded") && property_uri !== "v-s:parent" ) {
          item.object["v-s:parent"] = [ self.object ];
        }
        return item.object;
      });
    } else {
      self.object[property_uri] = self[property_uri].slice(0);
    }
  });
}

self.on("beforeSave", updateBlank);
//self.on("afterSave", updateAspect);

function updateBlank() {
  Object.getOwnPropertyNames(self.object.properties).map( function (property_uri) {
    if ( stopList.indexOf(property_uri) >= 0 ) { return; }
    if ( self.object.hasValue(property_uri) && self.object[property_uri][0] instanceof veda.IndividualModel && self.object[property_uri][0].is("v-s:Embedded")) {
      self[property_uri] = self.object[property_uri].map(function (item) {
        var blank = item.clone();
        var types = blank["rdf:type"];
        blank["v-te:targetType"] = types;
        blank["rdf:type"] = [ new veda.IndividualModel("v-te:Blank") ];
        blank["v-s:parent"] = [ self ];
        blank.save();
        return blank;
      });
    } else {
      self[property_uri] = self.object[property_uri].slice(0);
    }
  });
}
function updateAspect() {
  if (self["v-s:deleted"][0] == true) {
    asp["v-s:hasBlank"] = asp["v-s:hasBlank"].filter( function (i) { return i.id !== self.id;});
    asp.save();
  } else if (
    !asp["v-s:hasBlank"].filter( function (i) {return i.id === self.id;}).length
    && !self.hasValue("v-s:parent") // Not embedded
  ) {
    asp["v-s:hasBlank"] = asp["v-s:hasBlank"].concat(self);
    asp.save();
  }
}

//# sourceURL=v-te:BlankModel
  """
.

v-te:BlankTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "v-te:Blank class template"@en ;
  rdfs:label "Шаблон класса v-te:Blank"@ru ;
#  v-ui:forClass v-te:Blank ;
  v-ui:template """
<div role="tabpanel">
  <br>
  <ul class="nav nav-tabs nav-right hidden-print" role="tablist">
    <li class="pull-left"><h3 class="no-margin" about="@" property="rdfs:label"></h3></li>
    <li role="presentation"><a id="mgmt-pill" href="#mgmt" about="v-te:BlankMgmt" property="rdfs:label" aria-controls="mgmt" role="tab" data-toggle="tab"></a></li>
    <li role="presentation" class="active"><a id="blank-pill" href="#blank" about="v-te:Blank" property="rdfs:label" aria-controls="blank" role="tab" data-toggle="tab"></a></li>
  </ul>
  <br />
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="blank">
      <div id="object-container"></div>
      <div id="no-rights" class="alert alert-warning container hidden">
        <strong about="v-s:Attention" property="rdfs:label"></strong> <span about="v-s:NoRightsForOperation" property="rdfs:label"></span>
        <button class="btn btn-default" about="v-s:Back" property="rdfs:label" onclick="window.history.back();"></button>
      </div>
    </div>
    <div role="tabpanel" class="tab-pane" id="mgmt">
      <em about="rdfs:label" property="rdfs:label"></em>
      <p property="rdfs:label" class="view -edit search"></p>
      <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
      <br>
      <div>
        <button type="button" class="action btn btn-primary view -edit" id="edit" about="v-s:Edit" property="rdfs:label"/>
        <button type="button" class="action btn btn-success -view edit" id="save" about="v-s:Save" property="rdfs:label"/>
        <button type="button" class="action btn btn-link view -edit" id="delete" about="v-s:Delete" property="rdfs:label"/>
      </div>
    </div>
  </div>
</div>
<script>
  individual._init();
  var self = individual,
      objectContainer = $("#object-container", template),
      object = self.object;

  var _class = object["rdf:type"][0];
  alert('Open class create');
  if (_class.rights.hasValue("v-s:canCreate", true)) {
    object.present(objectContainer, undefined, "edit");
    object.one("afterSave", saveHandler);
    object.one("afterReset", cancelHandler);
    template.one("remove", function () {
      object.off("afterSave", saveHandler);
      object.off("afterReset", cancelHandler);
      self.off("beforeSave");
      self.off("afterSave");
      delete self.object;
    });
  } else {
    $("#no-rights", template).removeClass("hidden");
  }
  function saveHandler () {
    delete self.object;
    setTimeout(function () {
      riot.route("#/" + object.id);
    }, 100);
  }
  function cancelHandler () { window.history.back(); }
  //# sourceURL=v-te:BlankTemplate
</script>
  """
.

v-te:BlankTemplateShort
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "v-te:Blank class template"@en ;
  rdfs:label "Шаблон класса v-te:Blank"@ru ;
  v-ui:forClass v-te:Blank ;
  v-ui:template """
<div>
  <div id="object-container"></div>
  <div id="no-rights" class="alert alert-warning container hidden">
    <strong about="v-s:Attention" property="rdfs:label"></strong> <span about="v-s:NoRightsForOperation" property="rdfs:label"></span>
    <button class="btn btn-default" about="v-s:Back" property="rdfs:label" onclick="window.history.back();"></button>
  </div>
</div>
<script>
  individual._init();
  var self = individual,
      objectContainer = $("#object-container", template),
      object = self.object;

  var _class = object["rdf:type"][0];
  if (_class.rights.hasValue("v-s:canCreate", true)) {
    object.present(objectContainer, undefined, "edit");
    object.one("afterSave", saveHandler);
    object.one("afterReset", cancelHandler);
    template.one("remove", function () {
      object.off("afterSave", saveHandler);
      object.off("afterReset", cancelHandler);
      self.off("beforeSave");
      self.off("afterSave");
      delete self.object;
    });
  } else {
    $("#no-rights", template).removeClass("hidden");
  }
  function saveHandler () {
    delete self.object;
    setTimeout(function () {
      riot.route("#/" + object.id);
    }, 100);
  }
  function cancelHandler () { window.history.back(); }
  //# sourceURL=v-te:BlankTemplate
</script>
  """
.
